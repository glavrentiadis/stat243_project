---
title: "STAT243 Project"
author: "Grigorios Lavrentiadis"
date: "November 26, 2018"
output: pdf_document
---



# Sampling $x^*$

The `SamplePieceExp` function draws samples $x^*$ out of a piece-wise exponential distribution using the inverse sampling approach. 
Initially a $Pinv$ sample is drawn from a $0$ to $1$ uniform distribution that corresponds to the cumulative probability of the random sample $x^*$
To find the bin at which $x^*$ belongs, $Pinv$ is compared with the cumulative probability of each bin. 
$x^*$ belongs to the bin whose cumulative probability ($Pcum_i$) is the smallest out of all bins that have $Pcum$ larger than $Pinv$.
$x^*$ is estimated by solving the following cumulative probability equation, where $z_0$ is the left bound of the distribution and $P_j$ is the probability of bin $j$.


$$
P_{inv} = \int^{x^*}_{z_0} s(x) dx = \sum^i_{j=1}P_j + \int^{x^*}_{z_i} s(x) dx
$$

$DP$ equals to the probability $P(z_i > x > x^*)$ where $z_i$ is the lower bound of the bin $i$ where $x^*$ belongs

$$
DP = \int^{x^*}_{z_i} e^{h(x_j) + (x-x_j) h'(x_j)} dx 
$$
To simplify the equation we define: $a = h(x_j)-x_j h'(x_j)$ and $b = h'(x_j)$
From this equation, $x^*$ equals to:

$$
x^* = \frac{1}{b} log(DP~b~e^{-a} +  e^{b~z_i})
$$

```{r sample}

SamplePieceExp <- function(X,Z,H_norm,H_prime,Pcum){
  #SamplePieceExp draws a sample out of a piece wise exponential distribution
  #Input:
  # X: numeric array with all the values where h and h' have been evaluated
  # Z: numeric array with the ordinates at the intersections of the piece-wise distribution
  # H_norm: numeric array with the normalized elevations of exponential distribution at locations X
  # H_prime:  numeric array with the evaluations of the first derivative of h at the locations X
  # Pcum: numeric array with the cumulative probability of each of each segment 
  #Output:
  # x_star: random sample of the distribution
  
  #sample inverse probability 
  Pinv <- runif(1)
  
  #sample distribution bin
  i_bin <- sum(Pcum < Pinv) + 1 
  
  #sample x based on inverse prob
  a_coef <- H_norm[i_bin] - X[i_bin]*H_prime[i_bin] #intersect of each line seg. (log space)
  b_coef <- H_prime[i_bin] #slope of each line seg. (log space)
  DP <- Pinv - max(Pcum[i_bin-1],0) 
  
  #sample x_star
  x_star <- 1/b_coef*log(DP*b_coef*exp(-a_coef)+exp(b_coef*Z[i_bin]))
  
  return(x_star)
}

```

# Calculate probability of each segment

The following code calculates the probability of each segment $P_i$ of a piece-wise exponential distribution. 
The area under each segment is equal to:

$$
A_i = \int^{z_{i+1}}_{z_i} e^{h(z_i) + (x-x_i) h'(x_i)} dx = e^{h(x_i)} \frac{e^{-x_i h'(x_i)}}{h'(x_i)} (e^{h'(x_i) z_{i+1}}- e^{h'(x_i) z_i})
$$

where $z_{i+1}$ and ${z_i}$ are the bounds of each segment, $h(x_i)$ and $h'(x_i)$ are the values of the function and its derivative at $x_i$ which belongs to that segment.

To calculate the probability of each segment ($P_i$), the area of each segment is normalized by the total area

$$
P_i = \frac{A_i} {\sum^n_{j=1} A_j}
$$

The cumulative probability of each segment equal to the sum of the probabilies of all the segments to the left of and including the segment in question

$$
P_{cum~i} = \sum^i_{j=1} P_j
$$




```{r calc_p}

CalcProbBin <- function(X,Z,H,H_prime){
  #CalcProbBin calculates the probabilities of each segment of the exponential distribution.
  #Input: 
  # X: numeric array with all the values where h and h' have been evaluated
  # Z: numeric array with the ordinates at the intersections of the piecewise exponential function u
  # H: numeric array with the evaluations of function h at the locations X
  # H_prime:  numeric array with the evaluations of the first derivative of h at locations X
  #Output:
  # Pcum: numeric array with the cumulative probability of each of each segment 
  # log_s: numeric array with the normalized elevations of log(s) at locations X
  
  #number of bins
  n_bin <- length(Z) -1
  
  #calculate area under each bin (proportional to probabilty)
  a_coef <- H - X*H_prime #intersect of each line seg. (log space)
  b_coef <- H_prime #slope of each line seg. (log space)
  P <- exp(a_coef)/b_coef*(exp(b_coef*Z[-1]) - exp(b_coef*Z[-(n_bin+1)]))
  #normalized probabilites
  Ptot <- sum(P)
  P <- P/Ptot
  #cumulative probabilites
  Pcum <- cumsum(P) 
  #normalized height of distributions
  log_s <- H -log(Ptot)
  
  return(list(Pcum = Pcum, s = s, Ptot = Ptot))
}


#test function 
X <- c(-1.7,1.5,3)
Z <- c(-2,-0.1,2.25,4)
H <- c(-1.2653262,-0.9453262,-4.3203262)
H_prime <- c(1.7,-1.5,-3)
P_correct <- c(0.462418397,0.529588445,0.007993158)

temp1 <- CalcProbBin(X,Z,H,H_prime)




temp2 <- CalcProbBin(X,Z,temp1$s,H_prime)


error <- temp1$Pcum - cumsum(P_correct)



```



